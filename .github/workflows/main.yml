name: Global Stock Matrix Monitor

on:
  # 1. æ‰‹å‹•è§¸ç™¼ä¸¦è‡ªå®šç¾©å¸‚å ´åƒæ•¸
  workflow_dispatch:
    inputs:
      market:
        description: 'é¸æ“‡åŸ·è¡Œå¸‚å ´ (all / tw / us / cn / hk / jp / kr)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tw
          - us
          - cn
          - hk
          - jp
          - kr

  # 2. å®šæœŸè‡ªå‹•åŸ·è¡Œ (é€±ä¸€è‡³é€±äº”ï¼Œå°åŒ—æ™‚é–“ 18:30)
  schedule:
    - cron: '30 10 * * 1-5'

jobs:
  # éšæ®µä¸€ï¼šæº–å‚™çŸ©é™£åˆ—è¡¨
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix_list: ${{ steps.set-matrix.outputs.matrix_list }}
    steps:
      - id: set-matrix
        run: |
          if [[ "${{ github.event.inputs.market }}" == "all" || "${{ github.event_name }}" == "schedule" ]]; then
            echo "matrix_list=[\"tw\", \"us\", \"cn\", \"hk\", \"jp\", \"kr\"]" >> $GITHUB_OUTPUT
          else
            echo "matrix_list=[\"${{ github.event.inputs.market }}\"]" >> $GITHUB_OUTPUT
          fi

  # éšæ®µäºŒï¼šå¹³è¡ŒåŸ·è¡ŒæŠ“å–ä»»å‹™
  execute-task:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 360  # è¨­å®šæœ€é«˜ 6 å°æ™‚è¶…æ™‚ï¼Œæ‡‰å° MAX æ­·å²ä¸‹è¼‰
    
    strategy:
      fail-fast: false      # å³ä½¿å…¶ä¸­ä¸€å€‹å¸‚å ´å¤±æ•—ï¼Œå…¶ä»–å¸‚å ´ä¹Ÿè¦ç¹¼çºŒè·‘å®Œ
      matrix:
        # æ ¹æ“š prepare-matrix çš„çµæœé–‹å¤šå°è™›æ“¬æ©Ÿï¼ˆåŒæ™‚è·‘ 6 åœ‹ï¼‰
        market: ${{ fromJson(needs.prepare-matrix.outputs.matrix_list) }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # ä½¿ç”¨è¼ƒæ–°ç©©å®šç‰ˆ
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # âœ¨ é—œéµæ­¥é©Ÿï¼šå¾ Google Drive ä¸‹è¼‰è©²å¸‚å ´å°ˆå±¬çš„ DB æª”æ¡ˆ
      - name: Download Market Specific DB
        env:
          GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
        run: |
          python -c "
          import os, json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseDownload
          import io

          market = '${{ matrix.market }}'
          db_file = f'{market}_stock_warehouse.db'
          folder_id = '1ltKCQ209k9MFuWV6FIxQ1coinV2fxSyl'
          
          env_json = os.environ.get('GDRIVE_SERVICE_ACCOUNT')
          if not env_json:
              print('âŒ æœªè¨­å®š GDRIVE_SERVICE_ACCOUNT Secret')
              exit(0)
          
          info = json.loads(env_json)
          creds = service_account.Credentials.from_service_account_info(info)
          service = build('drive', 'v3', credentials=creds)
          
          query = f\"name = '{db_file}' and '{folder_id}' in parents and trashed = false\"
          files = service.files().list(q=query, fields='files(id)').execute().get('files', [])
          
          if files:
              file_id = files[0]['id']
              print(f'ğŸ“¡ åµæ¸¬åˆ°é›²ç«¯æª”æ¡ˆï¼Œæ­£åœ¨ä¸‹è¼‰ {db_file}...')
              request = service.files().get_media(fileId=file_id)
              fh = io.FileIO(db_file, 'wb')
              downloader = MediaIoBaseDownload(fh, request)
              done = False
              while not done:
                  status, done = downloader.next_chunk()
              print(f'âœ… ä¸‹è¼‰å®Œæˆã€‚')
          else:
              print(f'ğŸ†• é›²ç«¯å°šç„¡ {db_file}ï¼Œå°‡ç”± main.py å»ºç«‹æ–°æª”ã€‚')
          "

      # âœ¨ åŸ·è¡Œä¸»ç¨‹å¼ï¼šæ›´æ–°è³‡æ–™åº«ä¸¦è‡ªå‹•ä¸Šå‚³å›é›²ç«¯
      - name: Run Market Update
        env:
          GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          # é€™è£¡æœƒåŸ·è¡Œ main.py çš„ upload_to_drive é‚è¼¯
          python main.py ${{ matrix.market }}
